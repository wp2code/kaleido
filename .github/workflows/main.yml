name: Deploy Kaleido
on:
  push:
    tags:
      - v*
env:
  server_name: kaleido-server
jobs:
  release:
    name: Build And Release Kaleido Server
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Kaleido
        uses: actions/checkout@v2
      - name: Get Version
        id: get_version
        run: |
          VER=`echo $GITHUB_REF | cut -d / -f3`
          echo "VERSION=$VER" >> "$GITHUB_OUTPUT"
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
      - name: Install compress/unzip
        run: sudo apt-get update && sudo apt-get install -y zip unzip
      - name: Build With Maven
        run: mvn -B package -Pprod --file pom.xml
      - name: Archive File
        run: |
          mv -t ${{ env.server_name }}  ./kaleido-start/target/kaleido-server-start.jar ./kaleido-start/target/lib
          zip -r ${{ env.server_name }}.zip  ${{ env.server_name }} 
          ls -a
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.KALEIDO_TOKEN }}
          TZ: Asia/Shanghai
        with:
          tag_name: ${{steps.get_version.outputs.VERSION}}
          release_name: Release ${{steps.get_version.outputs.VERSION}}
          draft: false
          prerelease: false
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.KALEIDO_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.server_name }}.zip
          asset_name: ${{ env.server_name }}.zip
          asset_content_type: application/zip
